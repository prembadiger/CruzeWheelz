<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CruzeWheelz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --dark-bg: #1a1a1a;
            --card-bg: #242424;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --accent-color: #ffd700;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --sidebar-width: 250px;
            --nav-hover-bg: #2f2f2f;
            --nav-active-bg: #363636;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            display: flex;
            min-height: 1000px;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--card-bg);
            padding: 20px;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
        }

        .sidebar h1 {
            color: var(--accent-color);
            font-size: 1.5rem;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8d8d8d;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background-color: var(--nav-hover-bg);
            color: var(--text-primary);
        }

        .nav-link.active {
            background-color: var(--nav-active-bg);
            color: var(--text-primary);
        }

        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        #logoutBtn {
            margin-top: 530px;
            border-top: 2px solid #464646;
            color: var(--text-primary);
            border-radius: 0;
        }
        
        #logoutBtn:hover {
            background-color: var(--nav-hover-bg);
            color: var(--text-primary);
        }

        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: var(--sidebar-width);
        }

        .header {
            margin-bottom: 30px;
            display: block;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            position: relative;
            height: 450px;
            min-height: unset;
        }

        .chart-container h3 {
            color: var(--text-primary);
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .stat-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-card .trend {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .trend.up { color: var(--success-color); }
        .trend.down { color: var(--danger-color); }

        .data-table {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-header h2 {
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        .view-all {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            color: var(--text-secondary);
            font-weight: normal;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: inline-block;
            position: relative;
            cursor: help;
        }

        .status-pending {background-color: rgba(255, 205, 0, 0.2);color: #ffcd00;}
        .status-confirmed {background-color: rgba(0, 247, 99, 0.2);color: rgb(0, 255, 0);}
        .status-ongoing {background-color: rgba(0, 200, 81, 0.2);color: #00c851;}
        .status-completed {background-color: rgba(170, 170, 170, 0.2);color: #aaaaaa;}
        .status-cancelled { background-color: rgba(224, 41, 41, 0.712);color: #ffffff; }

        .status-badge[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 0.9em;
            white-space: normal;
            width: max-content;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        #status-select {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .action-btn {
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.589);
            color: rgb(0, 0, 0);
            font-size: 0.9rem;
        }

        .action-btn:hover {
            opacity: 0.9;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-content h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #444;
            border-radius: 6px;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group select {
            cursor: pointer;
        }

        .form-group input[type="number"] {
            width: 150px;
        }

        .form-group input[type="file"] {
            padding: 8px 0;
            border: none;
            background: none;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }

        .form-actions .action-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .form-actions .action-btn[type="submit"] {
            background-color: var(--accent-color);
            color: var(--dark-bg);
        }

        .form-actions .action-btn[type="button"] {
            background-color: var(--card-bg);
            color: var(--text-secondary);
            border: 1px solid #444;
        }

        .form-actions .action-btn:hover {
            opacity: 0.9;
        }

        /* Scrollbar styling */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: var(--dark-bg);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .vehicle-info {
            display: flex;
            align-items: center;
            min-width: 300px;
        }

        .vehicle-desc {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .status-active {
            background-color: var(--success-color);
        }

        .status-inactive {
            background-color: var(--danger-color);
        }

        .action-btn {
            padding: 6px;
            margin: 0 2px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .status-text {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ff0000;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: rgb(255, 255, 255);
            transition: .4s;
        }

        input:checked + .slider {
            background-color: rgb(88, 88, 88);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 24px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .status-badge {padding: 4px 8px;border-radius: 12px;font-size: 0.8em;text-transform: capitalize;}
        .status-active {background-color: rgba(0, 247, 99, 0.2);color: rgb(0, 255, 0);}
        .status-inactive {background-color: var(--danger-color);color: white;}
        .action-btn.delete-btn {background-color: var(--warning-color);color: var(--dark-bg);}
        .action-btn.delete-btn:hover {opacity: 0.9;}

        .time-period-selector {
            display: flex;
            gap: 10px;
        }

        .time-period-btn {
            background: var(--nav-hover-bg);
            border: none;
            color: var(--text-secondary);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .time-period-btn:hover {
            background: var(--nav-active-bg);
            color: var(--text-primary);
        }

        .time-period-btn.active {
            background: var(--accent-color);
            color: var(--dark-bg);
        }

        .chart-container h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <h1> CruzeWheelz</h1>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active" data-view="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="vehicles">
                    <i class="fas fa-car"></i>
                    <span>Vehicles</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="bookings">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Bookings</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="users">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-view="locations">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Locations</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </aside>

    <main class="main-content">
        <div class="header">
            <h1>Welcome, Admin</h1>
            <p>Here's what's happening with your car rental service</p>
        </div>

        <div id="dashboardView">
            <div class="stats-grid">
                <div class="stat-card">
                    <p>Total Revenue</p>
                    <h3>₹<span id="totalRevenue">0</span></h3>
                </div>
                <div class="stat-card">
                    <p>Total Users</p>
                    <h3><span id="totalUsers">0</span></h3>
                </div>
                <div class="stat-card">
                    <p>confirmed Bookings</p>
                    <h3><span id="activeBookings">0</span></h3>
                </div>
                <div class="stat-card">
                    <p>Ongoing Bookings</p>
                    <h3><span id="ongoingBookings">0</span></h3>
                </div>
                <div class="stat-card">
                    <p>Completed Bookings</p>
                    <h3><span id="completedBookings">0</span></h3>
                </div>
                <div class="stat-card">
                    <p>Total Bookings</p>
                    <h3><span id="totalBookings">0</span></h3>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3>
                        Revenue Trend
                        <div class="time-period-selector">
                            <button class="time-period-btn" data-period="week">Week</button>
                            <button class="time-period-btn active" data-period="month">Month</button>
                            <button class="time-period-btn" data-period="year">Year</button>
                        </div>
                    </h3>
                    <canvas id="revenueChart"></canvas>
                    <div class="chart-legend" id="revenueLegend"></div>
                </div>
                <div class="chart-container">
                    <h3>Booking Status Distribution</h3>
                    <canvas id="bookingsChart"></canvas>
                    <div class="chart-legend" id="bookingsLegend"></div>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">
                    <h2>Recent Bookings</h2>
                    <a href="#" class="view-all">View All</a>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Vehicle</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Payment Status</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable"></tbody>
                </table>
            </div>
        </div>

        <div id="bookingsView" style="display: none;">
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Vehicle</th>
                            <th>Dates</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Payment Status</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="allBookingsTable"></tbody>
                </table>
            </div>
        </div>

        <div id="usersView" style="display: none;">
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Total Bookings</th>
                            <th>Joined</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>

        <div id="vehiclesView" style="display: none;">
            <div class="data-table">
                <div class="table-header">
                    <h2>All Vehicles</h2>
                    <button class="action-btn">Add New Vehicle</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Seats</th>
                            <th>Transmission</th>
                            <th>Daily Rate</th>
                            <th>Rating</th>
                            <th>Locations</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vehiclesTable"></tbody>
                </table>
            </div>
        </div>

        <div id="locationsView" style="display: none;">
            <div class="header">
            </div>
            <div class="data-table">
                <div class="table-header">
                    <h2>All Locations</h2>
                    <button class="action-btn" onclick="showAddLocationModal()">
                        <i class="fas fa-plus"></i> Add Location
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="locationsTableBody">
                        <!-- Locations will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Check authentication on page load and periodically
        checkAuth();
        setInterval(checkAuth, 60000); // Check every minute

        async function checkAuth() {
            try {
                const response = await fetch('php/check_auth.php', {
                    credentials: 'same-origin' // Include cookies
                });
                const data = await response.json();
                console.log('Auth check response:', data);
                
                if (!data.success) {
                    console.log('Auth check failed, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Update admin name if available
                if (data.admin && data.admin.name) {
                    document.querySelector('.header h1').textContent = `Welcome, ${data.admin.name}`;
                }
                
                // Load dashboard data if we're on the main view
                if (document.getElementById('dashboardView').style.display !== 'none') {
                    loadDashboard();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
            }
        }

        // Add credentials to all fetch requests
        function fetchWithAuth(url, options = {}) {
            return fetch(url, {
                ...options,
                credentials: 'same-origin'
            });
        }

        // Update all fetch calls to use fetchWithAuth
        async function loadDashboard() {
            try {
                console.log('Loading dashboard data...');
                const response = await fetchWithAuth('admin_actions.php?action=get_stats');
                const data = await response.json();
                console.log('Dashboard data:', data);
                if (data.success) {
                    document.getElementById('totalBookings').textContent = data.stats.total_bookings;
                    document.getElementById('activeBookings').textContent = data.stats.confirmed_bookings;
                    document.getElementById('ongoingBookings').textContent = data.stats.ongoing_bookings;
                    document.getElementById('completedBookings').textContent = data.stats.completed_bookings;
                    document.getElementById('totalUsers').textContent = data.stats.total_users;
                    document.getElementById('totalRevenue').textContent = data.stats.total_revenue;

                    // Initialize charts
                    initializeCharts(data.stats);
                    loadBookings(); // Also load recent bookings
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        function initializeCharts(stats) {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            let revenueChart = null;

            function createRevenueChart(data, labels) {
                if (revenueChart) {
                    revenueChart.destroy();
                }

                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data,
                            borderColor: '#ffd700',
                            backgroundColor: 'rgba(255, 215, 0, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `₹${context.raw.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#888888',
                                    callback: function(value) {
                                        return '₹' + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#888888'
                                }
                            }
                        }
                    }
                });
            }

            // Initialize with monthly data
            createRevenueChart(stats.revenue_data, stats.revenue_labels);

            // Add click handlers for time period buttons
            document.querySelectorAll('.time-period-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const period = this.dataset.period;
                    
                    // Update active state
                    document.querySelectorAll('.time-period-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Fetch data for the selected period
                    try {
                        const response = await fetchWithAuth(`admin_actions.php?action=get_stats&period=${period}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            createRevenueChart(data.stats.revenue_data, data.stats.revenue_labels);
                        }
                    } catch (error) {
                        console.error('Error fetching revenue data:', error);
                    }
                });
            });

            // Bookings Status Chart
            const bookingsCtx = document.getElementById('bookingsChart').getContext('2d');
            const bookingStatusColors = {
                pending: '#ffc107',
                confirmed: '#28a745',
                ongoing: '#17a2b8',
                completed: '#6c757d',
                cancelled: '#dc3545'
            };

            const bookingsChart = new Chart(bookingsCtx, {
                type: 'bar',
                data: {
                    labels: ['Pending', 'Confirmed', 'Ongoing', 'Completed', 'Cancelled'],
                    datasets: [{
                        label: 'Number of Bookings',
                        data: [
                            stats.pending_bookings,
                            stats.confirmed_bookings,
                            stats.ongoing_bookings,
                            stats.completed_bookings,
                            stats.cancelled_bookings
                        ],
                        backgroundColor: [
                            bookingStatusColors.pending,
                            bookingStatusColors.confirmed,
                            bookingStatusColors.ongoing,
                            bookingStatusColors.completed,
                            bookingStatusColors.cancelled
                        ],
                        borderWidth: 0,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw} bookings`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#888888',
                                precision: 0
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#888888'
                            }
                        }
                    }
                }
            });

            // Add legends
            const bookingsLegend = document.getElementById('bookingsLegend');
            bookingsLegend.innerHTML = Object.entries(bookingStatusColors)
                .map(([status, color]) => `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${color}"></div>
                        <span>${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                    </div>
                `).join('');
        }

        async function loadBookings() {
            try {
                console.log('Loading bookings data...');
                const response = await fetchWithAuth('admin_actions.php?action=get_bookings');
                const data = await response.json();
                console.log('Bookings data:', data);
                if (data.success) {
                    const tableBody = document.getElementById('bookingsTable');
                    const allBookingsTable = document.getElementById('allBookingsTable');
                    const bookingsHTML = data.bookings.map(booking => `
                        <tr>
                            <td>#${booking.id}</td>
                            <td>${booking.user_name}</td>
                            <td>${booking.car_name}</td>
                            <td>${booking.pickup_date} - ${booking.return_date}</td>
                            <td>₹${booking.total_amount}</td>
                            <td>${booking.payment_method ? booking.payment_method.charAt(0).toUpperCase() + booking.payment_method.slice(1) : 'N/A'}</td>
                            <td>
                                <span class="status-badge payment-status-${booking.payment_status.toLowerCase()}">
                                    ${booking.payment_status.charAt(0).toUpperCase() + booking.payment_status.slice(1)}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge status-${booking.status}">
                                    ${booking.status}
                                </span>
                            </td>
                            <td>
                                <button class="action-btn" onclick="viewBooking(${booking.id})">View</button>
                                ${booking.status === 'cancelled' && booking.cancellation_reason ? 
                                    `<button class="action-btn" onclick="viewCancellationReason(${booking.id}, '${booking.cancellation_reason.replace(/'/g, "\\'")}')">View Reason</button>` 
                                    : ''}
                                <select class="action-btn" id="status-select" onchange="updateBookingStatus(${booking.id}, this.value)" style="margin-left: 5px; padding: 5px;">
                                    <option value="">Pending</option>
                                    <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirm</option>
                                    <option value="ongoing" ${booking.status === 'ongoing' ? 'selected' : ''}>Ongoing</option>
                                    <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancel</option>
                                </select>
                            </td>
                        </tr>
                    `).join('');
                    
                    if (tableBody) tableBody.innerHTML = bookingsHTML;
                    if (allBookingsTable) allBookingsTable.innerHTML = bookingsHTML;
                }
            } catch (error) {
                console.error('Bookings load error:', error);
            }
        }

        function viewCancellationReason(id, reason) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Cancellation Reason</h2>
                        </button>
                    </div>
                    <div style="padding: 20px;">
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">Booking #${id}</p>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; color: var(--text-primary);">
                            ${reason}
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="action-btn" style="background: none; border: none; color: var(--text-secondary); padding: 5px;" onclick="closeModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function loadUsers() {
            try {
                console.log('Loading users data...');
                const response = await fetchWithAuth('admin_actions.php?action=get_users');
                const data = await response.json();
                console.log('Users data:', data);
                if (data.success) {
                    const tableBody = document.getElementById('usersTable');
                    tableBody.innerHTML = data.users.map(user => `
                        <tr>
                            <td>#${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${user.total_bookings}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Users load error:', error);
            }
        }

        async function updateBookingStatus(bookingId, status) {
            if (!status) return; // Don't proceed if no status selected

            if (status === 'cancelled') {
                // Show cancellation modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Cancel Booking</h2>
                            <button class="modal-close" onclick="closeModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            <p style="margin-bottom: 20px; color: var(--text-secondary);">Please provide a reason for cancelling this booking:</p>
                            <textarea id="cancellationReason" style="width: 100%; padding: 10px; border-radius: 8px; background: var(--dark-bg); color: var(--text-primary); border: 1px solid #333; margin-bottom: 20px; min-height: 100px;" placeholder="Enter your reason here..."></textarea>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button class="action-btn" style="background: var(--card-bg); color: var(--text-primary);" onclick="closeModal()">Cancel</button>
                                <button class="action-btn" style="background: var(--danger-color); color: white;" onclick="confirmStatusUpdate(${bookingId}, '${status}')">Confirm</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                return;
            }

            // For other statuses, update directly
            try {
                const response = await fetchWithAuth('admin_actions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update_booking',
                        booking_id: bookingId,
                        status: status
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadBookings();
                    // Reload dashboard data to update revenue
                    loadDashboard();
                } else {
                    alert(data.message || 'Error updating booking status');
                }
            } catch (error) {
                console.error('Update booking error:', error);
                alert('Error updating booking status');
            }
        }

        async function confirmStatusUpdate(bookingId, status) {
            const reason = document.getElementById('cancellationReason').value.trim();
            
            if (!reason) {
                alert('Please provide a reason for cancellation');
                return;
            }

            try {
                const response = await fetchWithAuth('admin_actions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update_booking',
                        booking_id: bookingId,
                        status: status,
                        cancellation_reason: reason
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    closeModal();
                    loadBookings();
                    // Reload dashboard data to update revenue
                    loadDashboard();
                } else {
                    alert(data.message || 'Error updating booking status');
                }
            } catch (error) {
                console.error('Update booking error:', error);
                alert('Error updating booking status');
            }
        }

        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                const response = await fetchWithAuth('admin_actions.php?action=logout');
                const data = await response.json();
                if (data.success) {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'login.html';
            }
        });

        // Navigation
        document.querySelectorAll('.nav-link[data-view]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const view = this.dataset.view;
                showView(view);
                
                // Update active state
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function showView(view) {
            console.log('Showing view:', view);
            // Hide all views
            const views = ['dashboard', 'bookings', 'users', 'vehicles', 'locations'];
            views.forEach(v => {
                const element = document.getElementById(v + 'View');
                if (element) element.style.display = 'none';
            });
            
            // Show selected view
            const selectedView = document.getElementById(view + 'View');
            if (selectedView) {
                selectedView.style.display = 'block';
                console.log('Loading data for view:', view);
                // Load data for view
                switch(view) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'bookings':
                        loadBookings();
                        break;
                    case 'users':
                        loadUsers();
                        break;
                    case 'vehicles':
                        loadVehicles();
                        break;
                    case 'locations':
                        loadLocations();
                        break;
                }
            } else {
                console.error('View not found:', view);
            }
        } 

        async function loadVehicles() {
            try {
                const response = await fetchWithAuth('admin_actions.php?action=get_vehicles');
                const data = await response.json();
                if (data.success) {
                    const tableBody = document.getElementById('vehiclesTable');
                    tableBody.innerHTML = data.vehicles.map(vehicle => `
                        <tr>
                            <td>#${vehicle.id}</td>
                            <td>
                                <div class="vehicle-info">
                                    ${vehicle.image ? `<img src="../img/cars/${vehicle.image}" alt="${vehicle.name}" style="width: 150px; height: 80px; object-fit: cover; margin-right: 15px; border-radius: 4px;">` : ''}
                                    <div>
                                        <strong>${vehicle.name}</strong>
                                        ${vehicle.description ? `<p class="vehicle-desc">${vehicle.description.substring(0, 50)}${vehicle.description.length > 50 ? '...' : ''}</p>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td>${vehicle.category}</td>
                            <td>${vehicle.seats}</td>
                            <td>${vehicle.transmission}</td>
                            <td>₹${vehicle.daily_rate}</td>
                            <td>${vehicle.rating ? '★'.repeat(Math.round(vehicle.rating)) + ' ' + vehicle.rating : 'N/A'}</td>
                            <td>
                                ${vehicle.location_1 ? `<div>${vehicle.location_1}</div>` : ''}
                                ${vehicle.location_2 ? `<div>${vehicle.location_2}</div>` : ''}
                            </td>
                            <td>
                                <button class="action-btn" onclick="editVehicle('${vehicle.id}')" title="Edit Vehicle">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn" onclick="viewVehicleDetails('${vehicle.id}')" title="View Details">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Vehicles load error:', error);
            }
        }

        function loadLocations() {
            fetchWithAuth('admin_actions.php?action=get_locations')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tableBody = document.getElementById('locationsTableBody');
                        tableBody.innerHTML = '';
                        data.locations.forEach(location => {
                            tableBody.innerHTML += `
                                <tr>
                                    <td>${location.id}</td>
                                    <td>${location.name}</td>
                                    <td>
                                        <span class="status-badge status-${location.status.toLowerCase()}">
                                            ${location.status}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <label class="switch" title="Toggle Status">
                                                <input type="checkbox" 
                                                       ${location.status === 'active' ? 'checked' : ''} 
                                                       onclick="toggleLocationStatus(${location.id}, this, '${location.name}')">
                                                <span class="slider round"></span>
                                            </label>
                                            <button class="action-btn delete-btn" onclick="deleteLocation(${location.id})" title="Delete Location">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        console.error('Error loading locations:', data.message);
                    }
                })
                .catch(error => console.error('Error loading locations:', error));
        }

        function toggleLocationStatus(id, checkbox, name) {
            const isActive = checkbox.checked;
            const status = isActive ? 'active' : 'inactive';
            
            // Update UI immediately for better user experience
            const statusBadge = checkbox.closest('tr').querySelector('.status-badge');
            statusBadge.className = `status-badge status-${status}`;
            statusBadge.textContent = status;

            const data = {
                action: 'update_location',
                id: id,
                name: name,
                status: status
            };

            fetchWithAuth('admin_actions.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    // Revert changes if update failed
                    checkbox.checked = !isActive;
                    statusBadge.className = `status-badge status-${!isActive ? 'active' : 'inactive'}`;
                    statusBadge.textContent = !isActive ? 'active' : 'inactive';
                    alert(data.message || 'Error updating location status');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert changes if request failed
                checkbox.checked = !isActive;
                statusBadge.className = `status-badge status-${!isActive ? 'active' : 'inactive'}`;
                statusBadge.textContent = !isActive ? 'active' : 'inactive';
                alert('Error updating location status');
            });
        }

        function showAddLocationModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Add New Location</h2>
                    <form id="addLocationForm">
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="action-btn">Save</button>
                            <button type="button" class="action-btn" onclick="closeModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('addLocationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = {
                    action: 'add_location',
                    name: formData.get('name'),
                    status: 'active' // Default to active for new locations
                };

                fetchWithAuth('admin_actions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeModal();
                        loadLocations();
                    } else {
                        alert(data.message || 'Error adding location');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        }

        function deleteLocation(id) {
            if (confirm('Are you sure you want to delete this location?')) {
                fetchWithAuth('admin_actions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete_location',
                        id: id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadLocations();
                    } else {
                        alert(data.message || 'Error deleting location');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        function showAddVehicleModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Add New Vehicle</h2>
                    <form id="addVehicleForm">
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Category:</label>
                            <select name="category" required>
                                <option value="Luxury">Luxury</option>
                                <option value="SUV">SUV</option>
                                <option value="Sports">Sports</option>
                                <option value="Sedan">Sedan</option>
                                <option value="Coupe">Coupe</option>
                                <option value="Supercar">Supercar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Seats:</label>
                            <input type="number" name="seats" min="2" max="8" required>
                        </div>
                        <div class="form-group">
                            <label>Transmission:</label>
                            <select name="transmission" required>
                                <option value="Automatic">Automatic</option>
                                <option value="Manual">Manual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Daily Rate (₹):</label>
                            <input type="number" name="price" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Rating:</label>
                            <input type="number" name="rating" min="0" max="5" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Featured:</label>
                            <select name="featured">
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Image:</label>
                            <input type="file" name="image" accept="image/*">
                        </div>
                        <div class="form-group">
                            <label>Description:</label>
                            <textarea name="description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Features (one per line):</label>
                            <textarea name="features" rows="4" placeholder="Enter features, one per line"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Specifications (one per line):</label>
                            <textarea name="specifications" rows="4" placeholder="Enter specifications, one per line"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Primary Location:</label>
                            <select name="location_1" required>
                                <option value="">Select Location</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Secondary Location (Optional):</label>
                            <select name="location_2">
                                <option value="">Select Location</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="action-btn">Save</button>
                            <button type="button" class="action-btn" onclick="closeModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Load locations for dropdowns
            fetchWithAuth('admin_actions.php?action=get_locations')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const location1Select = modal.querySelector('select[name="location_1"]');
                        const location2Select = modal.querySelector('select[name="location_2"]');
                        
                        data.locations.forEach(location => {
                            if (location.status === 'active') {
                                const option = new Option(location.name, location.name);
                                location1Select.add(option.cloneNode(true));
                                location2Select.add(option);
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading locations:', error));

            document.getElementById('addVehicleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                // Convert features and specifications to JSON arrays
                const features = formData.get('features').split('\n').filter(f => f.trim());
                const specifications = formData.get('specifications').split('\n').filter(s => s.trim());
                
                formData.set('features', JSON.stringify(features));
                formData.set('specifications', JSON.stringify(specifications));
                formData.set('action', 'add_vehicle');

                // Log the form data for debugging
                console.log('Sending form data:', Object.fromEntries(formData));

                fetchWithAuth('admin_actions.php', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Server response:', data); // Add logging
                    if (data.success) {
                        closeModal();
                        loadVehicles();
                    } else {
                        alert(data.message || 'Error adding vehicle');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error adding vehicle. Please try again.');
                });
            });
        }

        function editVehicle(id) {
            console.log('Editing vehicle with ID:', id);
            const url = new URL('admin_actions.php', window.location.href);
            url.searchParams.append('action', 'get_vehicle');
            url.searchParams.append('id', id);
            
            console.log('Fetching from URL:', url.toString());
            
            fetchWithAuth(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Vehicle data received:', data);
                    if (data.success) {
                        const vehicle = data.vehicle;
                        console.log('Vehicle data:', vehicle);
                        
                        // Features and specifications are now pre-parsed by the server
                        const features = Array.isArray(vehicle.features) ? vehicle.features : [];
                        const specifications = Array.isArray(vehicle.specifications) ? vehicle.specifications : [];
                        
                        console.log('Features:', features);
                        console.log('Specifications:', specifications);
                        
                        const modal = document.createElement('div');
                        modal.className = 'modal';
                        modal.innerHTML = `
                            <div class="modal-content">
                                <h2>Edit Vehicle</h2>
                                <form id="editVehicleForm">
                                    <input type="hidden" name="id" value="${vehicle.id}">
                                    <div class="form-group">
                                        <label>Name:</label>
                                        <input type="text" name="name" value="${vehicle.name || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Category:</label>
                                        <select name="category" required>
                                            <option value="Luxury" ${vehicle.category === 'Luxury' ? 'selected' : ''}>Luxury</option>
                                            <option value="SUV" ${vehicle.category === 'SUV' ? 'selected' : ''}>SUV</option>
                                            <option value="Sports" ${vehicle.category === 'Sports' ? 'selected' : ''}>Sports</option>
                                            <option value="Sedan" ${vehicle.category === 'Sedan' ? 'selected' : ''}>Sedan</option>
                                            <option value="Coupe" ${vehicle.category === 'Coupe' ? 'selected' : ''}>Coupe</option>
                                            <option value="Supercar" ${vehicle.category === 'Supercar' ? 'selected' : ''}>Supercar</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Seats:</label>
                                        <input type="number" name="seats" value="${vehicle.seats || ''}" min="2" max="8" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Transmission:</label>
                                        <select name="transmission" required>
                                            <option value="Automatic" ${vehicle.transmission === 'Automatic' ? 'selected' : ''}>Automatic</option>
                                            <option value="Manual" ${vehicle.transmission === 'Manual' ? 'selected' : ''}>Manual</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Daily Rate (₹):</label>
                                        <input type="number" name="price" value="${vehicle.price || ''}" min="0" step="0.01" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Rating:</label>
                                        <input type="number" name="rating" value="${vehicle.rating || ''}" min="0" max="5" step="0.1">
                                    </div>
                                    <div class="form-group">
                                        <label>Featured:</label>
                                        <select name="featured">
                                            <option value="0" ${vehicle.featured == 0 ? 'selected' : ''}>No</option>
                                            <option value="1" ${vehicle.featured == 1 ? 'selected' : ''}>Yes</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Image:</label>
                                        <input type="file" name="image" accept="image/*">
                                        ${vehicle.image ? `<p>Current image: ${vehicle.image}</p>` : ''}
                                    </div>
                                    <div class="form-group">
                                        <label>Description:</label>
                                        <textarea name="description" rows="3">${vehicle.description || ''}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Features (one per line):</label>
                                        <textarea name="features" rows="4" placeholder="Enter features, one per line">${features.join('\n')}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Specifications (one per line):</label>
                                        <textarea name="specifications" rows="4" placeholder="Enter specifications, one per line">${specifications.join('\n')}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Primary Location:</label>
                                        <select name="location_1" required>
                                            <option value="">Select Location</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Secondary Location (Optional):</label>
                                        <select name="location_2">
                                            <option value="">Select Location</option>
                                        </select>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="action-btn">Update</button>
                                        <button type="button" class="action-btn" onclick="closeModal()">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        `;
                        document.body.appendChild(modal);

                        // Load locations for dropdowns
                        fetchWithAuth('admin_actions.php?action=get_locations')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    const location1Select = modal.querySelector('select[name="location_1"]');
                                    const location2Select = modal.querySelector('select[name="location_2"]');
                                    
                                    data.locations.forEach(location => {
                                        if (location.status === 'active') {
                                            const option = new Option(location.name, location.name);
                                            location1Select.add(option.cloneNode(true));
                                            location2Select.add(option);
                                        }
                                    });

                                    // Set selected locations
                                    if (vehicle.location_1) {
                                        location1Select.value = vehicle.location_1;
                                    }
                                    if (vehicle.location_2) {
                                        location2Select.value = vehicle.location_2;
                                    }
                                }
                            })
                            .catch(error => console.error('Error loading locations:', error));

                        document.getElementById('editVehicleForm').addEventListener('submit', function(e) {
                            e.preventDefault();
                            const formData = new FormData(this);
                            
                            // Convert features and specifications to JSON arrays
                            const features = formData.get('features').split('\n').filter(f => f.trim());
                            const specifications = formData.get('specifications').split('\n').filter(s => s.trim());
                            
                            formData.set('features', JSON.stringify(features));
                            formData.set('specifications', JSON.stringify(specifications));
                            formData.set('action', 'update_vehicle');

                            console.log('Sending form data:', Object.fromEntries(formData));

                            fetchWithAuth('admin_actions.php', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Server response:', data);
                                if (data.success) {
                                    closeModal();
                                    loadVehicles();
                                } else {
                                    alert(data.message || 'Error updating vehicle');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Error updating vehicle. Please try again.');
                            });
                        });
                    } else {
                        console.error('Error in response:', data.message);
                        alert(data.message || 'Error loading vehicle details');
                    }
                })
                .catch(error => {
                    console.error('Error fetching vehicle details:', error);
                    alert('Error loading vehicle details. Please try again.');
                });
        }

        function viewVehicleDetails(id) {
            console.log('Viewing vehicle details for ID:', id);
            const url = new URL('admin_actions.php', window.location.href);
            url.searchParams.append('action', 'get_vehicle');
            url.searchParams.append('id', id);
            
            console.log('Fetching from URL:', url.toString());
            
            fetchWithAuth(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.text().then(text => {
                        console.log('Raw response:', text);
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error('Error parsing JSON:', e);
                            throw new Error('Invalid JSON response from server');
                        }
                    });
                })
                .then(data => {
                    console.log('Vehicle details received:', data);
                    if (data.success) {
                        const vehicle = data.vehicle;
                        console.log('Vehicle data:', vehicle);
                        
                        // Features and specifications are now pre-parsed by the server
                        const features = Array.isArray(vehicle.features) ? vehicle.features : [];
                        const specifications = Array.isArray(vehicle.specifications) ? vehicle.specifications : [];
                        
                        console.log('Features:', features);
                        console.log('Specifications:', specifications);
                        
                        const modal = document.createElement('div');
                        modal.className = 'modal';
                        
                        modal.innerHTML = `
                            <div class="modal-content" style="max-width: 1200px; width: 95%;">
                                <h2 style="margin-bottom: 20px; color: white;">Vehicle Details</h2>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                                    <!-- Left Column - Image and Basic Info -->
                                    <div>
                                        ${vehicle.image ? 
                                            `<div style="width: 100%; height: 300px; overflow: hidden; border-radius: 8px; margin-bottom: 20px;">
                                                <img src="../img/cars/${vehicle.image}" alt="${vehicle.name}" 
                                                    style="width: 100%; height: 100%; object-fit: contain; background: #1a1a1a;">
                                            </div>` 
                                            : '<div style="height: 300px; background: #1a1a1a; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">No Image Available</div>'
                                        }
                                        
                                        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                                            <h3 style="color: #4CAF50; margin-bottom: 15px;">Basic Information</h3>
                                            <div style="display: grid; gap: 10px;">
                                                <div>
                                                    <span style="color: var(--text-secondary);">Name:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${vehicle.name || 'N/A'}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Category:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${vehicle.category || 'N/A'}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Seats:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${vehicle.seats || 'N/A'}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Transmission:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${vehicle.transmission || 'N/A'}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Daily Rate:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">₹${vehicle.price || 'N/A'}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Rating:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">
                                                        ${vehicle.rating ? '★'.repeat(Math.round(vehicle.rating)) + ' ' + vehicle.rating : 'N/A'}
                                                    </span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Featured:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">
                                                        ${vehicle.featured == 1 ? 'Yes' : 'No'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right Column - Additional Details -->
                                    <div style="display: flex; flex-direction: column; gap: 20px;">
                                        <!-- Description -->
                                        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                                            <h3 style="color: #4CAF50; margin-bottom: 15px;">Description</h3>
                                            <p style="color: var(--text-primary); line-height: 1.6;">
                                                ${vehicle.description || 'No description available'}
                                            </p>
                                        </div>
                                        
                                        <!-- Features -->
                                        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                                            <h3 style="color: #4CAF50; margin-bottom: 15px;">Features</h3>
                                            ${features.length > 0 ? 
                                                `<ul style="list-style: none; padding: 0; margin: 0;">
                                                    ${features.map(feature => `
                                                        <li style="color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center;">
                                                            <i class="fas fa-check" style="color: #4CAF50; margin-right: 10px;"></i>
                                                            ${feature}
                                                        </li>
                                                    `).join('')}
                                                </ul>` 
                                                : '<p style="color: var(--text-secondary);">No features listed</p>'
                                            }
                                        </div>
                                        
                                        <!-- Specifications -->
                                        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                                            <h3 style="color: #4CAF50; margin-bottom: 15px;">Specifications</h3>
                                            ${specifications.length > 0 ? 
                                                `<ul style="list-style: none; padding: 0; margin: 0;">
                                                    ${specifications.map(spec => `
                                                        <li style="color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center;">
                                                            <i class="fas fa-cog" style="color: #4CAF50; margin-right: 10px;"></i>
                                                            ${spec}
                                                        </li>
                                                    `).join('')}
                                                </ul>` 
                                                : '<p style="color: var(--text-secondary);">No specifications listed</p>'
                                            }
                                        </div>
                                        
                                        <!-- Locations -->
                                        <div style="background: var(--card-bg); padding: 20px; border-radius: 8px;">
                                            <h3 style="color: #4CAF50; margin-bottom: 15px;">Available Locations</h3>
                                            <div style="display: grid; gap: 10px;">
                                                ${vehicle.location_1 ? `
                                                    <div style="display: flex; align-items: center;">
                                                        <i class="fas fa-map-marker-alt" style="color: #4CAF50; margin-right: 10px;"></i>
                                                        <span style="color: var(--text-primary);">${vehicle.location_1}</span>
                                                    </div>
                                                ` : ''}
                                                ${vehicle.location_2 ? `
                                                    <div style="display: flex; align-items: center;">
                                                        <i class="fas fa-map-marker-alt" style="color: #4CAF50; margin-right: 10px;"></i>
                                                        <span style="color: var(--text-primary);">${vehicle.location_2}</span>
                                                    </div>
                                                ` : ''}
                                                ${!vehicle.location_1 && !vehicle.location_2 ? 
                                                    '<p style="color: var(--text-secondary);">No locations assigned</p>' 
                                                    : ''
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions" style="margin-top: 30px;">
                                    <button type="button" class="action-btn" onclick="closeModal()">Close</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    } else {
                        console.error('Error in response:', data.message);
                        alert(data.message || 'Error loading vehicle details');
                    }
                })
                .catch(error => {
                    console.error('Error fetching vehicle details:', error);
                    alert('Error loading vehicle details. Please try again.');
                });
        }

        function viewBooking(id) {
            fetchWithAuth(`admin_actions.php?action=get_booking_details&id=${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const booking = data.booking;
                        const modal = document.createElement('div');
                        modal.className = 'modal';
                        modal.innerHTML = `
                            <div class="modal-content" style="max-width: 800px;">
                                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                    <h2 class="modal-title" style="margin: 0; color: var(--text-primary);">Booking Details #${booking.id}</h2>
                                    <button onclick="closeModal()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; padding: 5px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>

                                <div style="padding: 20px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <div>
                                            <h3 style="color: var(--text-secondary); margin-bottom: 15px;">Booking Information</h3>
                                            <div style="display: grid; gap: 10px;">
                                                <div>
                                                    <span style="color: var(--text-secondary);">Customer:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${booking.user_name}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Vehicle:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${booking.car_name}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Pickup Date:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${booking.pickup_date}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Return Date:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${booking.return_date}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Total Amount:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">₹${booking.total_amount}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Payment Method:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${booking.payment_method ? booking.payment_method.charAt(0).toUpperCase() + booking.payment_method.slice(1) : 'N/A'}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Status:</span>
                                                    <span class="status-badge status-${booking.status}" style="margin-left: 10px;">${booking.status}</span>
                                                </div>
                                                ${booking.status === 'cancelled' && booking.cancellation_reason ? `
                                                    <div>
                                                        <span style="color: var(--text-secondary);">Cancellation Reason:</span>
                                                        <div style="color: var(--text-primary); margin-left: 10px; margin-top: 5px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                                                            ${booking.cancellation_reason}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div>
                                            <h3 style="color: var(--text-secondary); margin-bottom: 15px;">Location Information</h3>
                                            <div style="display: grid; gap: 10px;">
                                                <div>
                                                    <span style="color: var(--text-secondary);">Pickup Location:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${booking.pickup_location}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Return Location:</span>
                                                    <span style="color: var(--text-primary); margin-left: 10px;">${booking.return_location}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    } else {
                        alert(data.message || 'Error loading booking details');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading booking details');
                });
        }

        // Update the Add New Vehicle button click handler
        document.querySelector('#vehiclesView .table-header .action-btn').addEventListener('click', showAddVehicleModal);
    </script>
</body>
</html> 